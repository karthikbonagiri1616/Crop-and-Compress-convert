<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Karthik Academy ‚Ä¢ Compress, Convert & Crop Images</title>
<!-- Cropper.js -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
<style>
body {font-family:"Segoe UI",sans-serif;margin:0;padding:20px;background:linear-gradient(135deg,#ff7eb3,#ff758c);color:#fff;min-height:100vh;}
h1{text-align:center;font-size:2em;margin-bottom:5px;}
h4{text-align:center;font-weight:normal;margin-top:0;color:#ffe;}
p{text-align:center;margin-bottom:20px;font-size:1em;}
.card{max-width:900px;margin:auto;background:linear-gradient(135deg,#fff,#f0f0f8);color:#333;border-radius:16px;padding:25px;box-shadow:0 10px 25px rgba(0,0,0,0.2);}
.controls{display:flex;gap:15px;flex-wrap:wrap;justify-content:center;margin-bottom:20px;}
label{font-size:14px;font-weight:600;}
input[type="number"],select,input[type="file"],button{padding:8px;border-radius:8px;border:1px solid #ccc;}
.drop{border:3px dashed #ff7eb3;border-radius:16px;padding:40px;text-align:center;font-size:18px;color:#ff758c;background:#fff0f5;cursor:pointer;transition:all 0.3s ease;}
.drop:hover{background:#ffe4ef;transform:scale(1.02);}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:15px;margin-top:20px;}
.item{background:#fafafa;border-radius:12px;border:2px solid #eee;padding:12px;text-align:center;transition:transform 0.3s ease,box-shadow 0.3s ease;position:relative;}
.item:hover{transform:translateY(-5px);box-shadow:0 10px 20px rgba(0,0,0,0.15);}
.thumb{width:100%;height:140px;object-fit:cover;border-radius:12px;border:2px solid #ddd;}
.meta{margin-top:10px;}
.meta small{display:block;margin-top:5px;color:#555;font-size:0.9em;}
button{cursor:pointer;font-weight:600;transition:all 0.3s ease;}
button.compress{margin-top:10px;background:linear-gradient(135deg,#667eea,#764ba2);border:none;color:#fff;padding:10px 16px;border-radius:10px;}
button.crop{margin-top:5px;background:#ffb347;border:none;color:#fff;padding:6px 12px;border-radius:8px;}
button.remove{background:#ff4c4c;color:#fff;padding:6px 12px;border-radius:10px;position:absolute;top:8px;right:8px;border:none;}
button.bulk{margin-top:10px;background:linear-gradient(135deg,#ff7eb3,#ff758c);border:none;color:#fff;padding:10px 16px;border-radius:10px;}
.warning{text-align:center;color:#ff0000;font-weight:bold;margin-top:10px;}

/* Crop Modal Fix */
#cropModal{
  position:fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background:rgba(0,0,0,0.8);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:1000;
  flex-direction:column;
}
#cropContainer{
  display:flex;
  justify-content:center;
  align-items:center;
  max-width:95vw;
  max-height:85vh;
  width:100%;
  height:100%;
}
#cropImage{
  max-width:90vw;
  max-height:90vh;
  display:block;
  border:2px solid #fff;
}
#cropButtons{
  margin-top:15px;
  display:flex;
  gap:10px;
}
#cropClose{
  position:absolute;
  top:15px;
  right:20px;
  font-size:30px;
  background:none;
  border:none;
  color:#fff;
  cursor:pointer;
  z-index:1001;
}
</style>
</head>
<body>
<h1>Karthik Academy ‚Ä¢ Compress, Convert & Crop Images</h1>
<h4>Developed by Karthik Bonagiri</h4>
<p>Upload or drop images, enter size in KB, choose format, crop with draggable box, then download separately or all at once.</p>

<div class="card">
<div class="controls">
<label>Target Size (KB):
  <input id="sizeInput" type="number" min="0" value="200">
</label>
<label>Convert To:
  <select id="outFormat">
    <option value="image/jpeg">JPG</option>
    <option value="image/png">PNG</option>
    <option value="image/webp">WebP</option>
  </select>
</label>
<input id="fileInput" type="file" accept="image/*" multiple>
<button id="bulkDownload" class="bulk">Download All</button>
</div>
<div class="warning" id="bulkWarning"></div>
<div id="dropArea" class="drop">üìÅ Drag & drop images here</div>
<div id="results" class="grid"></div>
</div>

<!-- Crop Modal -->
<div id="cropModal">
  <button id="cropClose">&times;</button>
  <div id="cropContainer">
    <img id="cropImage"/>
  </div>
  <div id="cropButtons">
    <button id="cropSave" class="compress">Save Crop</button>
    <button id="cropCancel" class="remove">Cancel</button>
  </div>
</div>

<script>
const dropArea=document.getElementById('dropArea');
const fileInput=document.getElementById('fileInput');
const results=document.getElementById('results');
const sizeInput=document.getElementById('sizeInput');
const outFormatSelect=document.getElementById('outFormat');
const bulkDownload=document.getElementById('bulkDownload');
const bulkWarning=document.getElementById('bulkWarning');

let items=[];
let cropModal=document.getElementById('cropModal');
let cropImage=document.getElementById('cropImage');
let cropper;
let currentCropItem=null;

// Drag & drop
dropArea.addEventListener('click',()=>fileInput.click());
dropArea.addEventListener('dragover',e=>{e.preventDefault(); dropArea.style.borderColor="#764ba2"});
dropArea.addEventListener('dragleave',e=>{dropArea.style.borderColor="#ff7eb3"});
dropArea.addEventListener('drop',e=>{e.preventDefault(); dropArea.style.borderColor="#ff7eb3"; handleFiles([...e.dataTransfer.files]);});
fileInput.addEventListener('change',()=>handleFiles([...fileInput.files]));

function handleFiles(files){
  const images=files.filter(f=>f.type.startsWith('image/'));
  images.forEach(file=>{
    const url=URL.createObjectURL(file);
    const obj={file,url};
    items.push(obj);
    renderItem(obj);
  });
}

function renderItem(obj){
  const el=document.createElement('div');
  el.className='item';
  el.innerHTML=`
    <img class="thumb" src="${obj.url}">
    <div class="meta">
      <small>${obj.file.name} (${(obj.file.size/1024).toFixed(1)} KB)</small>
      <button class="crop">Crop</button>
      <button class="compress">Compress & Download</button>
    </div>
    <button class="remove">&times;</button>
  `;
  results.appendChild(el);

  el.querySelector('.remove').addEventListener('click',()=>{
    URL.revokeObjectURL(obj.url);
    items=items.filter(i=>i!==obj);
    el.remove();
  });

  el.querySelector('.crop').addEventListener('click',()=>openCrop(obj));
  el.querySelector('.compress').addEventListener('click',()=>compressAndDownload(obj,null));
}

// Bulk download
bulkDownload.addEventListener('click',async()=>{
  if(items.length===0)return;
  bulkWarning.textContent="üì• Bulk download will save all files directly.";
  for(const obj of items) await compressAndDownload(obj,null,false);
  setTimeout(()=>bulkWarning.textContent="",4000);
});

// Save file
async function saveFile(blob,filename){
  if('showSaveFilePicker' in window){
    try{
      const handle=await window.showSaveFilePicker({suggestedName:filename, types:[{description:'Image',accept:{'image/*':['.jpg','.jpeg','.png','.webp']}}]});
      const writable=await handle.createWritable();
      await writable.write(blob);
      await writable.close();
    }catch(err){console.error('Save canceled',err);}
  }else{
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob);
    a.download=filename;
    a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href),100);
  }
}

// Compress & download
async function compressAndDownload(obj, el=null, saveAs=true){
  const maxKB=parseInt(sizeInput.value);
  const outType=outFormatSelect.value;
  const blob=await compressToTargetSize(obj.file,maxKB,outType);
  const ext=outType==="image/png"?".png":(outType==="image/webp"?".webp":".jpg");
  const filename=obj.file.name.replace(/\.[^.]+$/,'')+"-converted"+ext;
  if(saveAs) await saveFile(blob,filename);
  if(el) el.querySelector('.meta').innerHTML+=`<small>Compressed: ${(blob.size/1024).toFixed(1)} KB</small>`;
}

async function compressToTargetSize(file,maxKB,outType){
  if(maxKB===0)return file;
  let quality=0.9;
  let blob=await compress(file,quality,outType);
  while(blob.size/1024>maxKB && quality>0.05){quality-=0.05; blob=await compress(file,quality,outType);}
  return blob;
}

function compress(file,quality,outType){
  return new Promise((resolve,reject)=>{
    const img=new Image();
    img.onload=()=>{
      const canvas=document.createElement('canvas'); canvas.width=img.width; canvas.height=img.height;
      const ctx=canvas.getContext('2d'); ctx.drawImage(img,0,0);
      canvas.toBlob(b=>resolve(b),outType,quality);
    };
    img.onerror=()=>reject();
    img.src=URL.createObjectURL(file);
  });
}

// Crop
function openCrop(obj){
  currentCropItem=obj;
  cropImage.src=obj.url;
  cropModal.style.display='flex';
  if(cropper) cropper.destroy();
  cropper=new Cropper(cropImage,{
    aspectRatio: NaN,
    viewMode:1,
    autoCropArea:1,
    movable:true,
    zoomable:true,
    rotatable:false,
    scalable:false
  });
}

document.getElementById('cropSave').addEventListener('click',()=>{
  if(cropper){
    const canvas=cropper.getCroppedCanvas();
    canvas.toBlob(blob=>{
      currentCropItem.file=new File([blob],currentCropItem.file.name,{type:currentCropItem.file.type});
      URL.revokeObjectURL(currentCropItem.url);
      currentCropItem.url=URL.createObjectURL(currentCropItem.file);

      // Update thumbnail
      const itemsEls=document.querySelectorAll('.item');
      itemsEls.forEach(el=>{
        const imgEl=el.querySelector('img.thumb');
        const nameText=el.querySelector('.meta small');
        if(nameText.textContent.includes(currentCropItem.file.name)){
          imgEl.src=currentCropItem.url;
          nameText.textContent=`${currentCropItem.file.name} (${(currentCropItem.file.size/1024).toFixed(1)} KB)`;
        }
      });

      cropper.destroy();
      cropModal.style.display='none';
    },currentCropItem.file.type || 'image/png',0.95);
  }
});

document.getElementById('cropCancel').addEventListener('click',()=>{if(cropper) cropper.destroy(); cropModal.style.display='none';});
document.getElementById('cropClose').addEventListener('click',()=>{if(cropper) cropper.destroy(); cropModal.style.display='none';});
</script>
</body>
</html>
