document.getElementById('cropSave').addEventListener('click',()=>{
  if(cropper){
    const canvas=cropper.getCroppedCanvas();
    canvas.toBlob(blob=>{
      // Replace the file with cropped version
      currentCropItem.file = new File([blob], currentCropItem.file.name, {type: currentCropItem.file.type});
      // Update URL for preview
      URL.revokeObjectURL(currentCropItem.url); // clean old blob
      currentCropItem.url = URL.createObjectURL(currentCropItem.file);

      // Update thumbnail and size display
      const itemsEls = document.querySelectorAll('.item');
      itemsEls.forEach(el=>{
        const imgEl = el.querySelector('img.thumb');
        const nameText = el.querySelector('.meta small');
        if(nameText.textContent.includes(currentCropItem.file.name)){
          imgEl.src = currentCropItem.url;
          nameText.textContent = `${currentCropItem.file.name} (${(currentCropItem.file.size/1024).toFixed(1)} KB)`;
        }
      });

      cropper.destroy();
      cropModal.style.display='none';
    }, currentCropItem.file.type || 'image/png', 0.95);
  }
});
